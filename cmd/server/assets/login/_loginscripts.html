{{define "loginscripts"}}
<script type="text/javascript">

  firebase.auth().onAuthStateChanged(function(user) {
    if (!user) {
      return
    }
    setSession(user)
  });

  function setSession(user) {
    let factorCount = user.multiFactor.enrolledFactors.length;
    user.getIdToken().then(idToken => {
      $.ajax({
        type: 'POST',
        url: '/session',
        data: {
          idToken: idToken,
          factorCount: factorCount,
        },
        headers: { 'X-CSRF-Token': '{{.csrfToken}}' },
        contentType: 'application/x-www-form-urlencoded',
        success: function(returnData) {
          // The user successfully signed in, redirect to realm selection.
          window.location.assign('/login/select-realm');
        },
        error: function(xhr, status, e) {
          // There was an error finding the user. Redirect to the
          // sign-out page to clear the firebase cookie and any session
          // data.
          //
          // The flash data may have more detailed error messages, which
          // will be displayed on the signout page.
          window.location.assign("/signout");
        }
      })
    });
  }
</script>
{{end}}

{{define "pindiv"}}
<div class="card mb-3 shadow-sm" style="display:none;" id="pinDiv">
  <div class="card-header">
    SMS Pin
    <button type="button" class="close" aria-label="Close" id="pinClose">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="card-body">
    <form id="pinForm" class="floating-form" action="/" method="POST">
      <div class="form-label-group">
        <input type="text" id="pin" name="pin" class="form-control" placeholder="Pin" autocomplete="one-time-code" required autofocus />
        <label for="pin">Pin</label>
        <small class="form-text text-muted">
          Please enter the numerical pin that was sent via SMS.
        </small>
      </div>

      <button type="submit" id="submitPin" class="btn btn-primary btn-block">Confirm pin</button>
      <a id="resendPin" class="card-link btn-block disabled" disabled>Resend SMS</a>
    </form>
  </div>
</div>
{{end}}
