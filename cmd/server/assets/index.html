{{define "index"}}
<!doctype html>
<html lang="en">
<head>
  {{template "head" .}}

  {{template "firebase" .}}
</head>

<body>
  {{template "navbar" .}}

  <main role="main" class="container">
    <div class="row">
      <div class="col">
        <div id="firebaseui-auth-container"></div>
      </div>
    </div>
  </main>

  {{template "scripts" .}}

  <script type="text/javascript">
    var uiConfig = {
      'callbacks': {
        // Called when the user has been successfully signed in.
        'signInSuccess': function(user, credential, redirectUrl) {
          user.getIdToken().then(
            idToken => {
              const csrfToken = getCookie('csrfToken')
              $.ajax({
                type:'POST',
                url: "/session",
                data: {idToken: idToken, csrfToken: csrfToken},
                contentType: 'application/x-www-form-urlencoded',
                success: function(returnData) {
                  window.location.assign('/home');
                },
                error: function(xhr, status, error) {
                  console.error(error);
                  window.location.assign(encodeURI("/signout"));
                }
              })
            })
          return false
        }
      },
      'credentialHelper': firebaseui.auth.CredentialHelper.NONE,
      'signInOptions': [
        firebase.auth.EmailAuthProvider.PROVIDER_ID
      ],
      // tosUrl and privacyPolicyUrl accept either url string or a callback
      // function.
      // Terms of service url/callback.
      'tosUrl': 'http://example.com',
      // Privacy policy url/callback.
      'privacyPolicyUrl': function() {
        window.location.assign('http://example.com');
      }
    };

    // Initialize the FirebaseUI Widget using Firebase.
    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.NONE)
    var ui = new firebaseui.auth.AuthUI(firebase.auth());

    function getCookie(name) {
      var v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
      return v ? v[2] : null;
    }

    $(window).on('load', function() {
      ui.start('#firebaseui-auth-container', uiConfig);
    });
  </script>
</body>
</html>
{{end}}
