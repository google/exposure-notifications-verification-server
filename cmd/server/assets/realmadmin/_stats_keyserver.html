{{define "realmadmin/_stats_keyserver"}}

<div class="card shadow-sm mb-3">
  <div class="card-header">
    <span class="oi oi-bar-chart mr-2 ml-n1"></span>
    Key server stats
  </div>
  <div class="card-body">
    <h5 class="card-title">Publish requests</h5>
  </div>
  <div id="keyserver_chart_div" class="h-100 w-100" style="min-height:325px;">
    <p class="text-center font-italic w-100 mt-5">Loading chart...</p>
  </div>
  <div class="card-body">
    <h5 class="card-title">Publish requests by OS</h5>
  </div>
  <div id="keyserver_os_chart_div" class="h-100 w-100" style="min-height:325px;">
    <p class="text-center font-italic w-100 mt-5">Loading chart...</p>
  </div>
  <div class="card-body">
    <h5 class="card-title">TEK age distribution <span class="sum-title">(7 day sum)</span></h5>
  </div>
  <div id="keyserver_tek_chart_div" class="h-100 w-100" style="min-height:325px;">
    <p class="text-center font-italic w-100 mt-5">Loading chart...</p>
  </div>
  <div class="slidecontainer" id="tek_slide_div">
  </div>
  <div class="card-body">
    <h5 class="card-title">Onset to upload distribution <span class="sum-title">>(7 day sum)</span></h5>
  </div>
  <div id="keyserver_onset_chart_div" class="h-100 w-100" style="min-height:325px;">
    <p class="text-center font-italic w-100 mt-5">Loading chart...</p>
  </div>
  <div class="slidecontainer" id="onset_slide_div">
  </div>
  <small class="card-footer d-flex justify-content-between text-muted">
    <a href="#" data-toggle="modal" data-target="#keyserver-stats-modal">Learn more about this chart</a>
    <span>
      <span class="mr-1">Export as:</span>
      <a href="/stats/realm/key-server.csv" class="mr-1">CSV</a>
      <a href="/stats/realm/key-server.json" target="_blank">JSON</a>
    </span>
  </small>
</div>

<div class="modal fade" id="keyserver-stats-modal" data-backdrop="static" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Key server stats</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mb-n3">
        <p>
          This graph reflects data from the key-server from for this realm,
          grouped by UTC day.
        </p>

        <strong>Total TEKs published</strong>
        <p>
          This line tracks the total number of TEKs published to the key-server.
          This is expected to be similar to the number of tokens claimed on the verification server.
        </p>

        <strong>Requests with revisions</strong>
        <p>
          This line tracks the total number of publish requests that contained
          at least one TEK revision
        </p>

        <strong>Request missing onset</strong>
        <p>
          This line tracks the total number of publish requests where no onset date
          was provided. These request are not included in the onset to upload distribution.
        </p>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  let stats;
  let smoothing = 7;

  let $slider =
    $(`<input type="range" class="slider w-100" id="tek_slider">`);
  let $onsetSlider =
    $(`<input type="range" class="slider w-100" id="onset_slider">`);

  $(function() {
    let $smoothDrop = $('#smooth-drop');

    $smoothDrop.on("click", function(event) {
      event.preventDefault();
      smoothing = $smoothDrop.val();
      $('.sum-title').text(`(${smoothing} day sum)`)

      let max = $slider.attr('max')
      $slider.attr('min', Math.min(smoothing, max));
      $onsetSlider.attr('min', Math.min(smoothing, max));
      $slider.val(max);
      $onsetSlider.val(max);
      $slider.trigger("input");
      $onsetSlider.trigger("input");
    });
  });

  google.charts.load('current', {
    packages: ['corechart'],
    callback: drawRealmCharts,
  });

  function drawRealmCharts() {
    $.ajax({
      url: '/stats/realm/key-server.json',
      dataType: 'json',
    })
    .done(function(data, status, xhr) {
      $slider.attr('min', Math.min(smoothing, data.length));
      $slider.attr('max', data.length);
      $slider.attr('value',data.length);
      $slider.attr('min', Math.min(smoothing, data.length));
      $onsetSlider.attr('max', data.length);
      $onsetSlider.attr('value',data.length);

      drawStatsChart(data);
      drawOSChart(data);
      drawTEKAgeChart(data);
      drawOnsetToUploadChart(data);
    })
    .fail(function(xhr, status, err) {
      flash.error('Failed to render key-server stats: ' + err);
    });
  }

  function drawStatsChart(data) {
    let $div = $('#keyserver_chart_div');

    if (!data.length) {
      $div.find('p').text('No data yet.');
      return;
    }
    stats = data;

    let dataTable = new google.visualization.DataTable();
    dataTable.addColumn('date', 'Date');
    dataTable.addColumn('number', 'TEKs published');
    dataTable.addColumn('number', 'Revision requests');
    dataTable.addColumn('number', 'Requests missing onset');

    stats.reverse().forEach(function(row) {
      dataTable.addRow([utcDate(row.day),
        row.total_teks_published,
        row.requests_with_revisions,
        row.requests_missing_onset_date,
      ]);
    });

    let dateFormatter = new google.visualization.DateFormat({
      pattern: 'MMM dd',
    });
    dateFormatter.format(dataTable, 0);

    let options = {
      colors: ['#28a745', '#a76e28', '#a72898'],
      chartArea: {
        left: 60,
        right: 40,
        bottom: 40,
        top: 40,
        width: '100%',
        height: '300',
      },
      hAxis: { format: 'M/d' },
      legend: { position: 'top' },
    };

    let chart = new google.visualization.LineChart($div.get(0));
    chart.draw(dataTable, options);
    chartData.push({
      chart: chart,
      data: dataTable,
      options: options,
    });
  }


  function drawOSChart(data) {
    let $div = $('#keyserver_os_chart_div');

    if (!data.length) {
      $div.find('p').text('No data yet.');
      return;
    }
    stats = data;

    let dataTable = new google.visualization.DataTable();
    dataTable.addColumn('date', 'Date');
    dataTable.addColumn('number', 'Unknown OS');
    dataTable.addColumn({type:'string', role:'tooltip', p: {html: true}})
    dataTable.addColumn('number', 'Android');
    dataTable.addColumn({type:'string', role:'tooltip', p: {html: true}})
    dataTable.addColumn('number', 'IOS');
    dataTable.addColumn({type:'string', role:'tooltip', p: {html: true}})

    stats.reverse().forEach(function(row) {
      let total = row.publish_requests.unknown + row.publish_requests.android + row.publish_requests.ios;

      dataTable.addRow([utcDate(row.day),
        row.publish_requests.unknown,
        "<strong>Unknown:</strong>" + row.publish_requests.unknown + " " +(row.publish_requests.unknown / total * 100).toPrecision(3) + "%",
        row.publish_requests.android,
        "<strong>Android:</strong>" + row.publish_requests.android + " " + (row.publish_requests.android / total * 10).toPrecision(3) + "%",
        row.publish_requests.ios,
        "<strong>IOS:</strong>" + row.publish_requests.ios + " " + (row.publish_requests.ios / total * 100).toPrecision(3) + "%",
      ]);
    });

    let dateFormatter = new google.visualization.DateFormat({
      pattern: 'MMM dd',
    });
    dateFormatter.format(dataTable, 0);

    let options = {
      colors: ['#6c757d', '#28a745', '#007bff'],
      chartArea: {
        left: 60,
        right: 40,
        bottom: 40,
        top: 40,
        width: '100%',
        height: '300',
      },
      hAxis: {
        format: 'M/d',
        gridlines: { color: 'transparent' },
      },
      legend: { position: 'top' },
      isStacked: true,
      tooltip: {isHtml: true},
    };

    let chart = new google.visualization.ColumnChart($div.get(0));
    chart.draw(dataTable, options);
    chartData.push({
      chart: chart,
      data: dataTable,
      options: options,
    });
  }

  let tekChart;
  let tekOptions;
  let tekData;
  function drawTEKAgeChart(data) {
    let $div = $('#keyserver_tek_chart_div');

    if (!data.length) {
      $div.find('p').text('No data yet.');
      return;
    }
    stats = data;

    tekOptions = {
      colors: ['#329262'],
      chartArea: {
        left: 60,
        right: 40,
        bottom: 40,
        top: 40,
        width: '100%',
        height: '300',
      },
      animation:{
        startup: false,
        duration: 500,
        easing: 'inAndOut',
      },
      legend: { position: 'none' },
      hAxis: {
        title: 'Days old',
        gridlines: { color: 'transparent' },
        ticks: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],
        showTextEvery: 1,
      },
      titlePosition: "out",
      title: `${smoothing} days from ` + stats[0].day.split("T")[0],
    };

    tekChart = new google.visualization.ColumnChart($div.get(0));
    tekData = getTEKDataTable(0);
    tekChart.draw(tekData, tekOptions);
    chartData.push({
      chart: tekChart,
      data: tekData,
      options: tekOptions,
    });
  }

  function getTEKDataTable(dateIndex) {
    let dataTable = new google.visualization.DataTable();
    dataTable.addColumn('number', 'days');
    dataTable.addColumn('number', 'count');
    dataTable.addColumn({type:'string', role:'style'})
    dataTable.addColumn({type:'string', role:'annotation'})

    // sum over last ${smoothing} days
    let table = new Array(stats[dateIndex].tek_age_distribution.length).fill(0);
    let i;
    for (i = dateIndex; i <= dateIndex + smoothing && i < stats.length; i++) {
      let row = stats[i];
      let j;
      for (j = 0; j < row.tek_age_distribution.length; j++) {
        table[j] += row.tek_age_distribution[j];
      }
    }

    for (i = 0; i < table.length; i++) {
      let r = [i+1, table[i],"",""]
      if (i == 15) {
        r[2] = "#6c757d";
        r[3] = ">15 days";
      }
      dataTable.addRow(r);
    }
    return dataTable;
  }

  let onsetChart;
  let onsetOptions;
  let onsetData;
  function drawOnsetToUploadChart(data) {
    let $div = $('#keyserver_onset_chart_div');

    if (!data.length) {
      $div.find('p').text('No data yet.');
      return;
    }
    stats = data;

    onsetOptions = {
      colors: ['#316395'],
      chartArea: {
        left: 60,
        right: 40,
        bottom: 40,
        top: 40,
        width: '100%',
        height: '300',
      },
      legend: { position: 'none' },
      hAxis: {
        title: 'Days from onset to upload',
        gridlines: { color: 'transparent' },
        ticks: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],
        showTextEvery: 1,
      },
      titlePosition: "out",
      title: `${smoothing} days from ` + stats[0].day.split("T")[0],
    };

    onsetChart = new google.visualization.ColumnChart($div.get(0));
    onsetData = getOnsetDataTable(0);
    onsetChart.draw(onsetData, onsetOptions);
    chartData.push({
      chart: onsetChart,
      data: onsetData,
      options: onsetOptions,
    });
  }

  function getOnsetDataTable(dateIndex) {
    let dataTable = new google.visualization.DataTable();
    dataTable.addColumn('number', 'days');
    dataTable.addColumn('number', 'count');
    dataTable.addColumn({type:'string', role:'style'})
    dataTable.addColumn({type:'string', role:'annotation'})

    // sum over last ${smoothing} days
    let table = new Array(stats[dateIndex].onset_to_upload_distribution.length).fill(0);
    let i;
    for (i = dateIndex; i <= dateIndex + smoothing && i < stats.length; i++) {
      let row = stats[i];
      let j;
      for (j = 0; j < row.onset_to_upload_distribution.length; j++) {
        table[j] += row.onset_to_upload_distribution[j];
      }
    }

    for (i = 0; i < table.length; i++) {
      let r = [i+1, table[i],"",""]
      if (i == 30) {
        r[2] = "#6c757d";
        r[3] = ">30 days";
      }
      dataTable.addRow(r);
    }
    return dataTable;
  }

  $(function() {
    $('#tek_slide_div').append($slider)
    $slider.on("input", function(event) {
        let indx = stats.length - $slider.val();
        tekOptions.title = `${smoothing} days from ` + stats[indx].day.split("T")[0];
        tekOptions.animation = {
          startup: false,
          duration: 500,
          easing: 'inAndOut',
        };
        tekData = getTEKDataTable(indx);

        tekChart.draw(tekData, tekOptions);
    });

    $('#onset_slide_div').append($onsetSlider)
    $onsetSlider.on("input", function(event) {
        let indx = stats.length - $onsetSlider.val();
        onsetOptions.title = `${smoothing} days from ` + stats[indx].day.split("T")[0];
        onsetOptions.animation = {
          startup: false,
          duration: 500,
          easing: 'inAndOut',
        };

        onsetData = getOnsetDataTable(indx);
        onsetChart.draw(onsetData, onsetOptions);
    });
  });
</script>

{{end}}
