{{define "code/issue/bulk"}}

{{$hasSMSConfig := .hasSMSConfig}}

<!doctype html>
<html lang="en">

<head>
  {{template "head" .}}
  <script
  src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"
  integrity="sha512-nOQuvD9nKirvxDdvQ9OMqe2dgapbPB7vYAMrzJihw5m+aNcf0dX53m6YxM4LgA9u8e9eg9QX+/+mPu8kCNpV2A=="
  crossorigin="anonymous"></script>
</head>

<body id="users-import" class="tab-content">
  {{template "navbar" .}}

  <main role="main" class="container">
    {{template "flash" .}}

    <div class="card mb-3 shadow-sm">
      <div class="card-header">Bulk issue</div>
      <div class="card-body">
        {{template "beta-notice" .}}

        {{if not $hasSMSConfig}}
        <div class="alert alert-danger">
          <span class="oi oi-warning"></span>
          No SMS provider is configured for this realm.
          Please contact a realm administrator to enable this feature.
        </div>
        {{end}}

        <p>
          Use this form to bulk issue codes.
        </p>

        <pre>Example file contents:
          <code>
            +12065555555,2020-11-10
          </code>
        </pre>

        <p>
          This form will read the CSV contents and call the issue API one-by-one.
        </p>
        <form id="form">
          <div class="form-label-group input-group">
            <input type="text" class="form-control" id="retry-code" placeholder="Retry code" required>
            <label for="retry-code">Retry code</label>
            <div class="input-group-append">
              <button class="btn btn-outline-secondary" id="new-code" type="button">New code</button>
            </div>
          </div>
          <small class="form-text text-muted pb-2">
            The retry code is a password for this bulk upload status in case it fails during processing.
            If you attempt this upload again with the same retry code, the server will be
            able to retry re-issue codes for phones which have not been successfully notified.
            You may use the same retry code for all of your uploads, but guard it like a password.
          </small>
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="remember-code">
            <label class="form-check-label text-secondary" for="remember-code">Remember code</label>
          </div>
          <small class="form-text text-muted pb-4">
            Your browser will remember this retry code.
          </small>

          <div class="form-label-group input-group">
            <input type="text" class="form-control" id="start-at" placeholder="Start at line" value="0">
            <label for="start-at">Start at line</label>
          </div>
          <small class="form-text text-muted pb-4">
            Parsing the CSV will start at this line. Begin at 0 for a new file.
            This can be used to resume a canceled or partial upload.
          </small>

          <div class="custom-file">
            <input type="file" class="custom-file-input" id="csv" accept=".csv" disabled required>
            <label class="custom-file-label" for="csv" id="file-label">Select a CSV file</label>
          </div>
          <button class="btn btn-primary" type="submit" id="import" disabled>Issue codes</button>
          <button class="btn btn-danger" id="cancel" disabled>Cancel</button>
        </form>
      </div>

      <div class="card-body">
        <div class="progress d-none" id="progress-div" style="display:none;">
          <div id="progress" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0"
            aria-valuemax="100"></div>
        </div>
        <table class="table table-bordered" id="csv-table">
          <thead>
            <tr>
              <th>Phone number</th>
              <th>Test date</th>
            </tr>
          </thead>
          <tbody id="csv-table-body"></tbody>
        </table>
      </div>
    </div>
  </main>

  <script type="text/javascript">
    $(function() {
      let $form = $('#form');
      let $csv = $('#csv');
      let $fileLabel = $('#file-label');
      let $import = $('#import');
      let $cancel = $('#cancel');
      let $table = $('#csv-table');
      let $tableBody = $('#csv-table-body');
      let $progressDiv = $('#progress-div');
      let $progress = $('#progress');
      let $retryCode = $('#retry-code');
      let $rememberCode = $('#remember-code');
      let $newCode = $('#new-code');
      let $startAt = $('#new-code');

      let randomString = getCookie("retryCode");
      if (randomString == "") {
        randomString = genCode();
      } else {
        $rememberCode.prop("checked", true);
      }
      $retryCode.val(randomString);

      let totalCreated = 0;
      let upload = readFile();

      $table.hide();

      {{if $hasSMSConfig}}
      if (typeof (FileReader) == "undefined") {
        flash.error("Your browser does not support the required HTML5 file reader.");
      } else {
        $csv.prop('disabled', false);
      }
      {{end}}

      $csv.change(function(file) {
        let fileName = file.target.files[0].name;
        $fileLabel.html(fileName);
        $import.prop('disabled', false);
      });

      $cancel.on('click', function(event) {
        upload.cancel();
        flash.error('Canceled batch upload.');
      });

      $newCode.on('click', function(event) {
        $retryCode.val(genCode());
      });

      $form.on('submit', function(event) {
        event.preventDefault();
        $import.prop('disabled', true);
        $cancel.prop('disabled', false);

        $table.show(100);
        $progressDiv.removeClass('d-none');

        if ($rememberCode.is(':checked')) {
          setCookie('retryCode',$retryCode.val(),14);
        } else {
          setCookie('retryCode','',-1);
        }

        var reader = new FileReader();
        reader.onload = upload.start;
        reader.readAsText($csv[0].files[0]);
      });

      const batchSize = 1;

      function readFile() {
        let retryCode = $retryCode.val();
        // State for managing cleanup and canceling
        let cancelUpload = false;
        let cancel = () => {
          cancelUpload = true;
        };

        let start = async function(e) {
          let rows = e.target.result.split('\n');
          let batch = [];
          totalUsersCreated = 0;
          $tableBody.empty();
          for (let i = parseInt($startAt.val()); i < rows.length && !cancelUpload; i++) {
            if (rows[i].trim() != "") {
              if (batch.length >= batchSize) {
                $tableBody.empty();
                batch = [];
              }

              let request = {};
              let cols = rows[i].split(',');
              request["phone"] = cols[0].trim();
              request["symptomDate"] = (cols.length > 1) ? cols[1].trim() : "";
              let hs  = String(CryptoJS.HmacSHA256(request["phone"], retryCode)).substr(0,36)
              request["uuid"] = hs.substr(0,8)+ '-' + hs.substr(9,4) + '-' + hs.substr(13,4) + '-' + hs.substr(17,4) + '-' + hs.substr(21,12);

              let row = "<tr><td>" + request["phone"] + "</td><td>" + request["symptomDate"] + "</td></tr>";
              $tableBody.append(row);

              batch.push(request);
            }

            if (batch.length >= batchSize || i == rows.length - 1) {
              await uploadBatch(batch).catch(err => { });
              $startAt.val(i);
              if (cancelUpload) {
                flash.warning("Successfully issued " + total + " codes."
                  + (rows.length - i) + " remaining.");
                break;
              }

              let percent = Math.floor((i + 1) * 100 / rows.length) + "%";
              $progress.width(percent);
              $progress.html(percent);
            }
          }

          if (!cancelUpload) {
            flash.alert("Successfully issued" + total + " codes.");
          }
          $table.fadeOut(400);
          $import.prop('disabled', false);
          $cancel.prop('disabled', true);
        };

        return { start, cancel };
      }
    });

    function uploadBatch(data) {
      return $.ajax({
        type: 'POST',
        url: '/code/issue',
        // TODO: at the moment we only support one-at-a-time
        data: JSON.stringify(data[0]),
        headers: { 'X-CSRF-Token': '{{.csrfToken}}' },
        contentType: 'application/json',
        success: function(result) {
          total += result.newUsers.length;
          if (result.error) {
            flash.error(result.error, "danger");
          }
        },
        error: function(xhr, status, e) {
          flash.error(e, "danger");
        },
      });
    }

    // generates a random 16 digit alphanumeric code
    function genCode() {
      return Math.random().toString(36).substr(2, 8) + Math.random().toString(36).substr(2, 8);
    }

    function setCookie(cname, cvalue, exdays) {
      var d = new Date();
      d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
      var expires = "expires="+d.toUTCString();
      document.cookie = cname + "=" + cvalue + ";" + expires;
    }

    function getCookie(cname) {
      var name = cname + "=";
      var ca = document.cookie.split(';');
      for(var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
          c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
          return c.substring(name.length, c.length);
        }
      }
      return "";
    }
  </script>
</body>

</html>
{{end}}
